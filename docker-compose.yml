version: "3.8"

services:

  # =========================
  # EUREKA SERVER
  # =========================
  eureka-server:
    build: ./eureka-server
    image: eureka-server:latest
    container_name: eureka-server
    ports:
      - "8761:8761"
    networks:
      - commande-network

  # =========================
  # CONFIG SERVER (PORT 9090)
  # =========================
  config-server:
    build: ./config-server
    image: config-server:latest
    container_name: config-server
    ports:
      - "9090:9090"
    depends_on:
      eureka-server:
        condition: service_started
    networks:
      - commande-network
    environment:
      SPRING_PROFILES_ACTIVE: native
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka
    volumes:
      - ./config-repo:/config-repo

  # =========================
  # MYSQL
  # =========================
  mysql:
    image: mysql:8
    container_name: mysql
    environment:
      MYSQL_ROOT_PASSWORD: root
    ports:
      - "3308:3306"
    networks:
      - commande-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 5

  # =========================
  # USER SERVICE
  # =========================
  user-service:
    build: ./user-service
    image: user-service:latest
    container_name: user-service
    ports:
      - "9092:9092"
    depends_on:
      mysql:
        condition: service_healthy
      config-server:
        condition: service_started
      eureka-server:
        condition: service_started
    networks:
      - commande-network
    environment:
      SPRING_APPLICATION_NAME: user-service
      SPRING_CONFIG_IMPORT: optional:configserver:http://config-server:9090
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka

  # =========================
  # COMMANDE SERVICE
  # =========================
  commande-service:
    build: ./commande-service
    image: commande-service:latest
    container_name: commande-service
    ports:
      - "9091:9091"
    depends_on:
      mysql:
        condition: service_healthy
      config-server:
        condition: service_started
      eureka-server:
        condition: service_started
    networks:
      - commande-network
    environment:
      SPRING_APPLICATION_NAME: commande-service
      SPRING_CONFIG_IMPORT: optional:configserver:http://config-server:9090
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka

  # =========================
  # GATEWAY
  # =========================
  gateway:
    build: ./gateway-service
    image: gateway:latest
    container_name: gateway-service
    ports:
      - "2020:2020"
    depends_on:
      config-server:
        condition: service_started
      eureka-server:
        condition: service_started
    networks:
      - commande-network
    environment:
      SPRING_APPLICATION_NAME: gateway
      SPRING_CONFIG_IMPORT: optional:configserver:http://config-server:9090
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka

# =========================
# NETWORK
# =========================
networks:
  commande-network:
    driver: bridge
